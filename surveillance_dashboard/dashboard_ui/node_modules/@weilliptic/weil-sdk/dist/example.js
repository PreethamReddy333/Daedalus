import { WeilWallet } from './wallet.js.js.js.js';
import { isAxiosError } from 'axios';
import fs from 'fs/promises';
import { base64ToHex, blobToHex } from './utils/formats.js.js.js.js';
import path from 'path';
const LEDGER_CONTRACTS_FOLDER = path.join(process.env.PLATFORM_SCRIPTS_ROOT, 'contracts/wasm');
const CONTRACTS_FOLDER = path.join(process.env.PLATFORM_SCRIPTS_ROOT, 'contracts/examples/rust');
const EXAMPLES_FOLDER = path.join(process.env.PLATFORM_SCRIPTS_ROOT, '../examples/contracts/examples');
const fileToHex = async (filePath) => {
    const fileContent = await fs.readFile(filePath);
    return blobToHex(new Blob([fileContent]));
};
// const sentinelEndpoint = 'http://sentinel:8000'
// const sentinelEndpoint = 'http://192.168.64.2:8000'
// const sentinelEndpoint =
//   'http://ec2-52-34-129-61.us-west-2.compute.amazonaws.com'
const sentinelEndpoint = 'http://192.168.64.10:8000';
// const sentinelEndpoint = 'https://sentinel.unweil.me'
const wallet = new WeilWallet({
    privateKey: '46d35e3bf1dd74dc132f10f1db5533eb320aca47b44849fd5352d299b5d08f0a',
    sentinelEndpoint,
    // transport: 'post',
});
async function* convertIterable(iterable) {
    for await (const chunk of iterable) {
        yield chunk.toString('utf-8');
    }
}
const run = async () => {
    /*const pods = await wallet.pods.list()
  
    pods.forEach((pod, index) => {
      console.log(`pod #${index + 1}: ${pod.podId} with port ${pod.http_port}`)
      console.log(`active nodes: ${pod.activeNodes.length}`)
      console.log(
        pod.activeNodes.map(node => `  ${node.host}:${node.port}`).join('\n'),
      )
      console.log(`inactive nodes: ${pod.inactiveNodes.length}`)
      console.log(
        pod.inactiveNodes.map(node => `  ${node.host}:${node.port}`).join('\n'),
      )
    })*/
    const ContractAddresses = {
        nft: base64ToHex('QAAAAAAAAABjNWY1NmNkY2M1NDY5ZDI3ZDNhNjM3ZmQzNDczYjMyMjcyMmUwZjViYTgwODRmNWIyMTdhZGQxNmZiYjYzZDY1JAAAAAAAAABQT0RfNzRhN2M5OTA2YzhlNGQ1ZDg1YTlmMzFlNTUyMTgxZDE='),
        ledger: '7b22636f6e74726163745f61646472657373223a2265613564373033343564643064326462323332343133363465316339663630623066623932396534613639393365373338663764326366356366333261643735222c22706f645f6964223a22504f445f3764326539363833363162333432613038346633333565613238646638336639227d',
        yutaka: 'aaaaaaw64lx7pumca3y4srf6jhk5dfhxviabq5umopwgua6x2odmjdodpe',
        chatbot: 'aaaaaassdhelmwhjgacxuv5u3g4tuyhelpwqwbillifnrgnbajk3pctr5a',
        galois: '7b22636f6e74726163745f61646472657373223a2265613564373033343564643064326462323332343133363465316339663630623066623932396534613639393365373338663764326366356366333261643735222c22706f645f6964223a22504f445f6665323132333165656639353434326561373234666264343235313465373064227d',
    };
    const testNft = async () => {
        const mintResult = await wallet.contracts.execute(ContractAddresses.nft, 'mint', {
            name: '55fcf4c8',
            uri: 's3://nftbucket/55fcf4c8',
            to_address: 'a5fc25a96b815cc9a26cee92ef9069e9_',
        });
        console.log('-------------');
        console.log(mintResult);
    };
    const testDetails = async () => {
        const transferResult = await wallet.contracts.execute(ContractAddresses.yutaka, 'details', {});
        console.log('-------------');
        console.log(transferResult);
    };
    const testYutaka = async () => {
        const transferResult = await wallet.contracts.execute(ContractAddresses.yutaka, 'transfer', {
            to_addr: '3e35eb533d45213716d6a8a2880d78f1e369e738b5171f1c3892a8fef95a54f4',
            amount: 10000,
        });
        console.log('-------------');
        console.log(transferResult);
        const balanceResult = await wallet.contracts.execute(ContractAddresses.yutaka, 'balance_for', {
            addr: '3e35eb533d45213716d6a8a2880d78f1e369e738b5171f1c3892a8fef95a54f4',
        });
        console.log('-------------');
        console.log(balanceResult);
    };
    const testListModels = async () => {
        const result = await wallet.contracts.execute(ContractAddresses.chatbot, 'list_models');
        console.log('-------------');
        console.log(result);
    };
    const createChatbotThread = async () => {
        const result = await wallet.contracts.execute(ContractAddresses.chatbot, 'new_thread', { model: 'qwen2.5' });
        console.log('-------------');
        console.log(result);
    };
    const testChatbot = async () => {
        const result = await wallet.contracts.execute(ContractAddresses.chatbot, 'chat_query', {
            id: 0,
            query_str: 'what are the pros of working in tech?',
            model: 'qwen2.5',
        }, { stream: true });
        let index = 0;
        let prevTime = new Date().getTime();
        for await (const chunk of result) {
            const currentTime = new Date().getTime();
            console.log(`This is chunk #${index}. Response time: ${currentTime - prevTime}ms`);
            console.log('-------------');
            console.log(chunk);
            console.log('-------------');
            index++;
            prevTime = currentTime;
        }
    };
    const testYutakaDetails = async () => {
        const result = await wallet.contracts.execute(ContractAddresses.yutaka, 'details', {});
        console.log('-------------');
        console.log(result);
    };
    const testDeployLedger = async () => {
        const [body, widl] = await Promise.all(['ledger_applet.wasm', 'ledger.widl'].map(fileName => fileToHex(path.join(LEDGER_CONTRACTS_FOLDER, fileName))));
        const result = await wallet.contracts.deploy(body, widl, {
            name: 'Ledger',
            pods: 'all',
        });
        console.log(JSON.stringify(result, null, 2));
    };
    const testDeployCounter = async () => {
        const [body, widl] = await Promise.all(['counter.wasm', 'counter.widl'].map(fileName => fileToHex(path.join(CONTRACTS_FOLDER, fileName))));
        const result = await wallet.contracts.deploy(body, widl, {});
        console.log(JSON.stringify(result, null, 2));
    };
    const testDeployYutaka = async () => {
        const [body, widl] = await Promise.all(['yutaka.wasm', 'yutaka.widl'].map(fileName => fileToHex(path.join(CONTRACTS_FOLDER, fileName))));
        const pods = await wallet.pods.list();
        const result = await wallet.contracts.deploy(body, widl, {
            pods: pods[0].podId,
        });
        console.log(JSON.stringify(result, null, 2));
    };
    const testDeployGalois = async () => {
        const [body, widl] = await Promise.all(['galois.wasm', 'galois.widl'].map(fileName => fileToHex(path.join(CONTRACTS_FOLDER, fileName))));
        const pods = await wallet.pods.list();
        const result = await wallet.contracts.deploy(body, widl, {
            pods: pods[0].podId,
        });
        console.log(JSON.stringify(result, null, 2));
    };
    const testDeployAsciiArt = async () => {
        const [body, widl] = await Promise.all(['asciiart.wasm', 'asciiart.widl'].map(fileName => fileToHex(path.join(CONTRACTS_FOLDER, fileName))));
        const result = await wallet.contracts.deploy(body, widl, {});
        console.log(JSON.stringify(result, null, 2));
    };
    const testDeployWebServer = async () => {
        const files = [
            'rust/webserver/target/wasm32-unknown-unknown/release/webserver.wasm',
            'rust/webserver/webserver.widl',
        ];
        const [body, widl] = await Promise.all(files.map(fileName => fileToHex(path.join(EXAMPLES_FOLDER, fileName))));
        const result = await wallet.contracts.deploy(body, widl, {});
        console.log(JSON.stringify(result, null, 2));
    };
    try {
        // await wallet.connection.test()
        // console.log('test successful')
        // await testDeployCounter()
        // await testDeployLedger()
        await testDeployYutaka();
        // await testDeployGalois/()
        // await testDeployAsciiArt()
        // await testDeployWebServer()
        // await testNft()
        // await testYutakaDetails()
        // await createChatbotThread()
        // await testChatbot()
        // await testListModels()
        // await testDetails()
    }
    catch (error) {
        console.log('-------------');
        if (isAxiosError(error)) {
            const { response } = error;
            if (response) {
                console.error(`ERROR ${response.status}`);
                console.log(response.data);
            }
            else if (typeof error.message === 'string') {
                console.error(`UNKNOWN ERROR`);
                console.error(error);
            }
        }
        else {
            throw error;
        }
    }
};
run();
//# sourceMappingURL=example.js.map